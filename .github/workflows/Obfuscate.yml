name: Obfuscate

on:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 17 * * *'  # 每天UTC 17:00 (北京时间凌晨1点)

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Download build script
      run: wget -O build.js https://raw.githubusercontent.com/bia-pain-bache/BPB-Worker-Panel/refs/heads/main/scripts/build.js
      
    - name: Install build dependencies
      run: |
        npm init -y
        npm install jszip
      
    - name: Run build script to generate worker files
      run: node build.js
      
    - name: Copy generated worker.js to root as origin.js
      run: cp dist/worker.js origin.js
      
    - name: Install obfuscation dependencies
      run: |
        npm install javascript-obfuscator -g
        npm install javascript-obfuscator
        
    - name: Obfuscate the code
      run: |
        javascript-obfuscator dist/worker.js --output dist/worker-obfuscated.js --compact true --control-flow-flattening true --control-flow-flattening-threshold 0.75 --dead-code-injection true --dead-code-injection-threshold 0.4 --debug-protection true --debug-protection-interval true --disable-console-output true --identifier-names-generator hexadecimal --log false --numbers-to-expressions true --rename-globals true --rotate-string-array true --self-defending true --shuffle-string-array true --split-strings true --split-strings-chunk-length 10 --string-array true --string-array-encoding rc4 --string-array-threshold 0.75 --string-array-wrappers-count 2 --string-array-wrappers-chained-calls true --string-array-wrappers-parameters-max-count 2 --string-array-wrappers-type function --transform-object-keys true --unicode-escape-sequence true
        
    - name: Create obfuscated zip
      run: |
        npm install jszip
        node -e "
        const JSZip = require('jszip');
        const fs = require('fs');
        const obfuscatedCode = fs.readFileSync('./dist/worker-obfuscated.js', 'utf8');
        const zip = new JSZip();
        zip.file('_worker.js', obfuscatedCode);
        zip.generateAsync({
            type: 'nodebuffer',
            compression: 'DEFLATE'
        }).then(nodebuffer => fs.writeFileSync('./dist/worker-obfuscated.zip', nodebuffer));
        "
      
    - name: List generated files
      run: ls -la dist/
      
    - name: Upload obfuscated files
      uses: actions/upload-artifact@v4
      with:
        name: obfuscated-build
        path: |
          origin.js
          dist/worker-obfuscated.js
          dist/worker-obfuscated.zip
        retention-days: 1